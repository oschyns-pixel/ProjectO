<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S.D.C. Minimalist (v2 - Final)</title>
    <style>
        :root{--bg-color:#1a1a2e;--text-color:#e0e0e0;--primary-color:#00aaff;--container-bg:#2a2a4e;--border-color:#444;--success-color:#4caf50;--error-color:#ff4d4d;}body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background-color:var(--bg-color);color:var(--text-color);margin:0;display:flex;justify-content:center;align-items:center;min-height:100vh;}.container{width:80%;max-width:900px;background-color:var(--container-bg);border-radius:8px;padding:2rem;box-shadow:0 4px 12px rgba(0,0,0,0.4);display:flex;gap:2rem;}.controls{flex:1;}.log-area{flex:2;}h1{color:var(--primary-color);text-align:center;margin-top:0;}fieldset{border:1px solid var(--border-color);border-radius:4px;padding:1rem;margin-bottom:1.5rem;}legend{color:var(--primary-color);font-weight:bold;padding:0 0.5rem;}.mirror-options label{display:block;margin-bottom:0.5rem;cursor:pointer;}button{background-color:var(--primary-color);color:white;border:none;padding:0.8rem 1.5rem;border-radius:4px;font-size:1rem;font-weight:bold;cursor:pointer;width:100%;transition:background-color 0.2s;}button:hover{background-color:#0088cc;}#log{background-color:#111;border:1px solid var(--border-color);height:300px;overflow-y:auto;padding:1rem;font-family:"Courier New",Courier,monospace;font-size:0.9rem;white-space:pre-wrap;border-radius:4px;}.log-entry{margin-bottom:0.5rem;}.log-entry.error{color:var(--error-color);}.log-entry.success{color:var(--success-color);}.log-entry .time{color:#888;margin-right:0.5rem;}
    </style>
</head>
<body>
    <div class="container">
        <div class="controls">
            <h1>S.D.C. MVP</h1>
            <fieldset>
                <legend>Stake Mirrors</legend>
                <div class="mirror-options">
                    <label><input type="checkbox" name="mirror" value="com" checked> .com</label>
                    <label><input type="checkbox" name="mirror" value="games"> .games</label>
                    <label><input type="checkbox" name="mirror" value="bet"> .bet</label>
                    <label><input type="checkbox" name="mirror" value="bz"> .bz</label>
                    <label><input type="checkbox" name="mirror" value="jp"> .jp</label>
                    <label><input type="checkbox" name="mirror" value="ac" checked> .ac</label>
                </div>
            </fieldset>
            <button id="startButton">Starte Claim Prozess</button>
        </div>
        <div class="log-area">
             <fieldset>
                <legend>Log</legend>
                <div id="log"></div>
             </fieldset>
        </div>
    </div>

    <script>
        const startButton = document.getElementById('startButton');
        const logContainer = document.getElementById('log');
        const mirrorCheckboxes = document.querySelectorAll('input[name="mirror"]');

        function logMessage(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.innerHTML = `<span class="time">[${time}]</span>`;
            logEntry.appendChild(document.createTextNode(message));
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        async function startProcess() {
            logMessage("Prozess gestartet...");
            if (typeof window.TM === 'undefined') {
                logMessage("Tampermonkey Skript nicht gefunden. Ist es aktiv?", "error"); return;
            }

            const selectedMirrors = Array.from(mirrorCheckboxes).filter(cb => cb.checked).map(cb => cb.value);
            if (selectedMirrors.length === 0) {
                logMessage("Bitte mindestens einen Mirror auswählen.", "error"); return;
            }

            logMessage(`Konfiguriere Agenten für: ${selectedMirrors.join(', ')}`);
            await window.TM.setMirrors(selectedMirrors);
            
            logMessage("Warte kurz, damit Widgets geladen werden...");
            await new Promise(resolve => setTimeout(resolve, 2000));

            // --- KORREKTUR #1: Wir verarbeiten alle Mirrors parallel ---
            const processingPromises = selectedMirrors.map(mirror => processMirror(mirror));
            await Promise.all(processingPromises);
            
            logMessage("Alle ausgewählten Mirrors wurden verarbeitet.", "success");
        }

        async function processMirror(mirror) {
            logMessage(`Verarbeite Mirror: ${mirror}...`);
            try {
                logMessage(`  -> Fordere CAPTCHA-Token an...`);
                const token = await window.TM.getToken(mirror);
                if (!token) { throw new Error("Token konnte nicht empfangen werden. Prüfe Stake-Tab."); }
                logMessage(`  -> Token für '${mirror}' erfolgreich erhalten.`, "success");
                
                await claimDrop(mirror, token);

            } catch (err) {
                logMessage(`  -> FEHLER bei '${mirror}': ${err.message}`, "error");
            }
        }
        
        async function claimDrop(mirror, token) {
            logMessage(`    -> Führe 'StakeFetch' für den Reload-Bonus aus...`);
            
            // --- KORREKTUR #2: Das ist die richtige Payload ---
            const payload = {
                "operationName": "claimFaucet",
                "variables": { "turnstileToken": token }, // Name 'turnstileToken', nicht 'captcha'
                "query": "mutation claimFaucet($turnstileToken: String!) {\n  claimFaucet(turnstileToken: $turnstileToken) {\n    ...FaucetClaim\n    __typename\n  }\n}\n\nfragment FaucetClaim on FaucetClaim {\n  id\n  amount\n  currency\n  __typename\n}\n"
            };
            
            try {
                const result = await window.TM.StakeFetch(mirror, payload);
                const responseData = result.response;
                console.log(`Antwort für ${mirror}:`, responseData);

                if (responseData?.data?.claimFaucet) {
                    const claimedAmount = responseData.data.claimFaucet.amount;
                    logMessage(`    -> ERFOLG für '${mirror}'! ${claimedAmount} geclaimed.`, "success");
                } else if (responseData?.errors) {
                    const errorMessage = responseData.errors[0]?.message || 'Unbekannter API-Fehler';
                    throw new Error(`API Fehler: ${errorMessage}`);
                } else {
                    throw new Error("Antwort vom Server war nicht im erwarteten Format.");
                }

            } catch(e) {
                throw e; // Wirft den Fehler nach oben zur `processMirror` Funktion.
            }
        }

        startButton.addEventListener('click', startProcess);
        logMessage("Anwendung bereit (v2).");
    </script>
</body>
</html>
